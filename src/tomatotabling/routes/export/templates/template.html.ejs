<%
const PAGE_WIDTH = 297 * 4;
const PAGE_HEIGHT = 210 * 4;
const HORI_PADDING = 28;
const VERT_PADDING = 20;
const DAY_WIDTH = 20;
const TIME_HEIGHT = 16;
const HEADER_HEIGHT = 80;
const TIMELINE_HEIGHT = 40;
const NOTE_HEIGHT = 20;
const TABLE_WIDTH = PAGE_WIDTH - HORI_PADDING * 2;
const TABLE_HEIGHT = PAGE_HEIGHT - VERT_PADDING * 2 - HEADER_HEIGHT - TIMELINE_HEIGHT - NOTE_HEIGHT;
const TIME_WIDTH = (TABLE_WIDTH - DAY_WIDTH) / 24;
const ROWS = filledGrid.reduce((rows, day) => rows + day.length, 0);
const TABLE_HBORDERS = (ROWS + 1) * 1;
const ROW_HEIGHT = (TABLE_HEIGHT - TABLE_HBORDERS - TIME_HEIGHT) / ROWS;
const MODULE_SIZE = settings.module === 'full' ? 14 : 20;
const CELL_PADDING = 2;
const CELL_FONT_SIZE = 10;
%>

<html>
<head>
<style>
html, body {
	margin: 0;
	padding: 0;
}
body {
	width: <%=PAGE_WIDTH%>px;
	height: <%=PAGE_HEIGHT%>px;
	padding: <%=VERT_PADDING%>px <%=HORI_PADDING%>px;
	font-family: sans-serif;
	box-sizing: border-box;
}

table {
	table-layout: fixed;
	border-collapse: collapse;
	max-height: <%=TABLE_HEIGHT%>px;
	max-width: <%=TABLE_WIDTH%>px;
}
td {
	border-left: 1px solid #ccc;
}
tr {
	border-bottom: 1px solid #000;
}
td:last-child {
	border-right: 1px solid #000;
}
td.activity, th {
	border: 1px solid #000;
}
.time {
	width: <%=TIME_WIDTH%>px;
	max-width: <%=TIME_WIDTH%>px;
	text-align: right;
	border-left: none;
	border-right: none;
	height: <%=TIME_HEIGHT%>px;
}
.time>.text {
	font-weight: 400;
	display: inline-block;
	font-size: 12px;
	-webkit-transform: translate3d(50%,0,0);
}
.time:first-child, .day {
	width: <%=DAY_WIDTH%>px;
	max-width: <%=DAY_WIDTH%>px;
}
.day {
	font-size: 16px;
}
.day>.text {
	-webkit-writing-mode: vertical-lr;
	-webkit-transform: rotate(180deg);
}
td.activity {
	background: #ddd;
	font-size: <%=CELL_FONT_SIZE%>px;
	padding: 8px;
	position: relative;
	overflow: hidden;
}
td.activity>.top {
	position: absolute;
	left: <%=CELL_PADDING%>px; top: <%=CELL_PADDING%>px; right: <%=CELL_PADDING%>px;
}
td.activity>.bottom {
	position: absolute;
	left: <%=CELL_PADDING%>px; bottom: <%=CELL_PADDING%>px; right: <%=CELL_PADDING%>px;
	display: -webkit-flex;
	-webkit-align-items: flex-end;
}
td.activity>.top>.code {
	float: left;
}
td.activity>.top>.weeks {
	float: right;
}
td.activity>.bottom>.staffs {
	text-align: right;
}
td.activity>.bottom>.flex {
	-webkit-flex: 1 1;
}
td.activity>.module {
	text-align: center;
	font-size: <%=MODULE_SIZE%>px;
	font-weight: 700;
	position: absolute;
	top: 50%; left: 0; right: 0; bottom: 50%;
}
td.activity>.module>.text {
	-webkit-transform: translate3d(0,-50%,0);
}
.row {
	height: <%=ROW_HEIGHT%>px;
}
.header {
	height: <%=HEADER_HEIGHT%>px;
	text-align: center;
}
.note {
	height: <%=NOTE_HEIGHT%>px;
	font-size: 14px;
}
.heading {
	font-size: 20px;
	font-weight: 700;
}
.generated {
	font-size: 12px;
	color: #666;
}
.timeline {
	width: <%=TABLE_WIDTH%>px;
	height: <%=TIMELINE_HEIGHT%>px;
	font-size: 12px;
}
.timeline>.line {
	height: 1px;
	background: #000;
}
.timeline>.cells {
	display: -webkit-flex;
	text-align: center;
}
.timeline>.cells>.week {
	-webkit-flex: 7 0;
}
.timeline>.cells>* {
	box-sizing: border-box;
	border-right: 1px solid #000;
}
.timeline>.cells>:first-child {
	border-left: 1px solid #000;
}
</style>
</head>
<body>

<div class="header">
<div class="heading">Teaching Timetable</div>
<div class="generated">Generated by Tomatotabling at <%=now%></div>
</div>

<div class="timeline">
	<div class="cells">
		<% for (const month of months) { %>
			<div style="-webkit-flex:<%=month.length%> 0"><%=month.month%></div>
		<% } %>
	</div>
	<div class="line"></div>
	<div class="cells">
		<div style="-webkit-flex:<%=paddings[0]%> 0; border-left: none"></div>
		<% for (let week = semester[0]; week <= semester[1]; ++week) { %>
			<div class="week"><%=week%></div>
		<% } %>
		<div style="-webkit-flex:<%=paddings[1]%> 0; border: none"></div>
	</div>
</div>

<table>
	<thead>
		<tr>
			<% for (const time of times) { %>
				<th class="time"><span class="text"><%=time%></span></th>
			<% } %>
		</tr>
	</thead>
	<tbody>
		<% for (const [dayIdx, day] of filledGrid.entries()) { %>
			<% for (const [rowIdx, row] of day.entries()) { %>
			<tr class="row">
				<% if (rowIdx === 0) { %><th class="day" rowspan="<%=day.length%>"><span class="text"><%=days[dayIdx]%></span></th><% } %>
				<% for (const activity of row) { %>
					<% if (activity === null) { %>
						<td></td>
					<% } else { %>
						<td class="activity" colspan="<%=activity.end - activity.start%>">
							<div class="top">
								<div class="code"><%=activity.code%></div>
								<div class="weeks"><%=activity.weeks%></div>
							</div>
							<div class="bottom">
								<div class="rooms">
									<% for (const room of activity.rooms) { %><div><%=room%></div><% } %>
								</div>
								<div class="flex"></div>
								<div class="staffs">
									<% for (const staff of activity.staffs) { %><div><%=staff%></div><% } %>
								</div>
							</div>
							<div class="module">
								<div class="text">
									<% for (const module of activity.modules) { %><div><%=module%></div><% } %>
								</div>
							</div>
						</td>
					<% } %>
				<% } %>
			</tr>
			<% } %>
		<% } %>
	</tbody>
</table>

<div class="note">There is no guarantee that the information in this timetable is correct or updated. It is your responsibility to check against the officially released timetable.</div>

</body>
</html>
